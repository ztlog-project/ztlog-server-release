name: ZTLog Admin Deploy to EC2

on:
  push:
    branches: [ "dev", "main" ]
    paths:
      - 'ztlog-admin/**'
      - 'ztlog-core/**'
      - 'Dockerfile-admin'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-admin.yml'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        run: chmod +x gradlew && ./gradlew clean build -x test

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ADMIN Image Build & Push
        run: |
          docker build -f Dockerfile-admin -t ${{ secrets.DOCKERHUB_USERNAME }}/ztlog-admin .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/ztlog-admin

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: EC2 SSH Deployment
        uses: appleboy/ssh-action@master
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          SPRING_ENV: ${{ github.ref_name == 'main' && 'prd' || 'dev' }}
          API_PORT: ${{ github.ref_name == 'main' && '8088' || '9088' }}
          ADM_PORT: ${{ github.ref_name == 'main' && '8089' || '9089' }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DOCKERHUB_USERNAME,AWS_ACCESS_KEY,AWS_SECRET_KEY,SPRING_ENV,API_PORT,ADM_PORT
          script: |
            set -e
            
            # 1. 프로젝트 폴더가 없으면 생성하고 이동 후 클론
            if [ ! -d "/home/ec2-user/apps/${{ github.event.repository.name }}" ]; then
              mkdir -p "/home/ec2-user/apps/${{ github.event.repository.name }}"
              cd "/home/ec2-user/apps/${{ github.event.repository.name }}"
              git clone "https://github.com/${{ github.repository }}.git" .
            else
              # 폴더가 있으면 이동해서 pull
              cd "/home/ec2-user/apps/${{ github.event.repository.name }}"
              git pull origin ${{ github.ref_name }}
            fi
            
            # 2. 로그 폴더 분리 생성 (소스 폴더 외부 절대 경로)
            mkdir -p "/home/ec2-user/logs/admin"
            
            # 3. .env 파일 절대 경로에 직접 작성 (변수 사용 안 함)
            {
              echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}"
              echo "ENV=${{ github.ref_name == 'main' && 'prd' || 'dev' }}"
              echo "API_PORT=${{ github.ref_name == 'main' && '8088' || '9088' }}"
              echo "ADM_PORT=${{ github.ref_name == 'main' && '8089' || '9089' }}"
              echo "DB_NAME=${{ github.ref_name == 'main' && 'ztlog_prd' || 'ztlog_dev' }}"
              echo "AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}"
              echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}"
            } > "/home/ec2-user/apps/${{ github.event.repository.name }}/.env"
            
            # 4. 배포 실행 (절대 경로 파일 지정 및 강제 재시작)
            docker-compose -f "/home/ec2-user/apps/${{ github.event.repository.name }}/docker-compose.yml" pull ztlog-admin
            docker-compose -f "/home/ec2-user/apps/${{ github.event.repository.name }}/docker-compose.yml" up -d --force-recreate ztlog-admin
            docker image prune -f
