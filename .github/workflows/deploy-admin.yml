name: ZTLog Admin Web Server Deploy to EC2

on:
  push:
    branches: [ "develop", "main" ]
    paths:
      - 'ztlog-admin/**'
      - 'ztlog-core/**'
      - '.github/workflows/deploy-admin.yml'  # workflow 파일 변경시도 배포

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build ADMIN Module
        run: chmod +x gradlew && ./gradlew :ztlog-admin:build -x test

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "ztlog-admin/build/libs/ztlog-admin-0.0.1-SNAPSHOT.jar"
          target: "/home/ec2-user/apps/admin"
          strip_components: 3

      - name: SSH Restart ADMIN
        uses: appleboy/ssh-action@master
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GITHUB_REF, AWS_ACCESS_KEY, AWS_SECRET_KEY, AWS_S3_BUCKET
          script: |
            NOW=$(date +%Y%m%d_%H%M%S)

            if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
              ENV="prd"
              ADM_PORT=8089
            else
              ENV="dev"
              ADM_PORT=9089
            fi

            # 기존 프로세스 종료
            PID=$(pgrep -f ztlog-admin || true)
            if [ -n "$PID" ]; then
              echo "기존 프로세스($PID) 종료 중..."
              kill -15 $PID 2>/dev/null || true
              sleep 5
              kill -9 $PID 2>/dev/null || true
            fi

            # 로그 디렉토리 생성
            mkdir -p /home/ec2-user/apps/admin/log

            # 새 프로세스 실행
            nohup java -Xmx256M -Xms256M \
              -Dspring.profiles.active=$ENV \
              -Dserver.port=$ADM_PORT \
              -jar /home/ec2-user/apps/admin/ztlog-admin-0.0.1-SNAPSHOT.jar \
              >> /home/ec2-user/apps/admin/log/admin_${NOW}.log 2>&1 </dev/null &

            disown $!

            echo "배포 스크립트 실행 완료 (PID: $!)"
            exit 0