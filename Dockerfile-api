# ================================================================
#  Stage 1 — Builder  (JDK for Gradle compilation)
#
#  Layer-cache strategy for Gradle multi-module projects:
#   1. Gradle wrapper                  → cached unless wrapper version changes
#   2. All build scripts (no src yet)  → cached unless a build.gradle changes
#   3. Warm-up dependency download     → cached if build scripts unchanged
#   4. Source code copy                → always fresh
#   5. bootJar assembly                → always fresh
# ================================================================
FROM eclipse-temurin:17-jdk-jammy AS builder
WORKDIR /workspace

# 1. Gradle wrapper
COPY gradlew .
COPY gradle/ gradle/
RUN chmod +x gradlew

# 2. Build scripts for every module (settings resolution needs them all)
COPY build.gradle settings.gradle ./
COPY ztlog-core/build.gradle  ztlog-core/build.gradle
COPY ztlog-api/build.gradle   ztlog-api/build.gradle
COPY ztlog-admin/build.gradle ztlog-admin/build.gradle

# 3. Warm up dependency cache (failure is non-fatal — restricted networks)
RUN ./gradlew :ztlog-api:dependencies --no-daemon 2>/dev/null || true

# 4. Source for modules the API depends on (ztlog-core is a compile-time dep)
COPY ztlog-core/src ztlog-core/src
COPY ztlog-api/src  ztlog-api/src

# 5. Build the fat JAR; tests run as a separate CI job
RUN ./gradlew :ztlog-api:bootJar -x test --no-daemon

# ================================================================
#  Stage 2 — Runtime  (slim JRE — compiler not needed in prod)
# ================================================================
FROM eclipse-temurin:17-jre-jammy
LABEL maintainer="zoetrope56"

ENV TZ=Asia/Seoul
WORKDIR /app

COPY --from=builder /workspace/ztlog-api/build/libs/*.jar ztlog-api-0.0.1-SNAPSHOT.jar

ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar /app/ztlog-api-0.0.1-SNAPSHOT.jar"]
