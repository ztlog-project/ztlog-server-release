# 1단계: Gradle 빌드 스테이지
FROM eclipse-temurin:17-jdk-jammy AS builder

WORKDIR /app

# Gradle Wrapper 및 빌드 파일 복사
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .

# 모듈 소스 복사
COPY ztlog-core ztlog-core
COPY ztlog-api ztlog-api

# Gradle 빌드 실행 (테스트 제외)
RUN chmod +x gradlew && ./gradlew :ztlog-api:build -x test

# 2단계: 실행 스테이지 (경량화)
FROM eclipse-temurin:17-jre-jammy

LABEL authors="zoetrope56"
LABEL description="ZTLog API Server"
LABEL version="0.0.1"

WORKDIR /app

# 타임존 설정
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 빌드된 JAR 파일만 복사
COPY ztlog-api/build/libs/*.jar ztlog-api-0.0.1-SNAPSHOT.jar

# 비root 사용자 생성 및 권한 설정
RUN useradd -m -u 1000 ztlog && chown -R ztlog:ztlog /app
#USER ztlog

# 포트 노출 (dev: 9088, prd: 8088)
EXPOSE 8088 9088

# 헬스체크
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:${SERVER_PORT:-8088}/front/actuator/health || exit 1

# JAVA_OPTS 환경변수로 JVM 옵션 주입 가능
ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar ztlog-api.jar"]
